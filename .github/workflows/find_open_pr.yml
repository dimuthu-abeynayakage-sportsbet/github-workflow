name: "Open PR's"
run-name: Find open pull requests v6 ðŸ·ï¸
on: push
  # schedule:
  #  - cron: "*/15 * * * *"

jobs:
  active-pull-request:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
   # - name: Print Active PR's
   #   run: | 
   #     openPrs="$(gh pr list --json title,url)"
   #     echo 'OPEN_PULL_REQUESTS='$openPrs >> $GITHUB_ENV
      #env:
      #  GH_TOKEN: ${{ github.token }}
    - name: Colleting Open Pull Requests
      run: |
        #echo "Current Repo - ${{ github.event.repository.name }}"
        openPrs="$(gh pr list --json title,url)"
        echo 'OPEN_PULL_REQUESTS='$openPrs
        ALL_PR_MESSAGES=""
        for row in $(echo "${OPEN_PULL_REQUESTS}" | jq -r '.[] | @base64'); do
          _jq() {
            echo ${row} | base64 --decode | jq -r ${1}
          }
          title=$(_jq '.title')
          url=$(_jq '.url')
          ALL_PR_MESSAGES+="â€¢ <$url|$title>\n"
        done
        echo 'FORMATTED_PR_MESSAGES='$ALL_PR_MESSAGES >> $GITHUB_ENV
      env:
        GH_TOKEN: ${{ github.token }}
    - name: Send Slack Message
      id: slack
      uses: slackapi/slack-github-action@v1.25.0
      with:
        channel-id: 'C06K1EC0N5B'
        payload: |
          {"blocks":[{"type":"section","text":{"type":"mrkdwn","text":"Team :wave:"}},{"type":"section","text":{"type":"mrkdwn","text":"Following pull requests still open for *${{ github.event.repository.name }}*:"}},{"type":"section","text":{"type":"mrkdwn","text":"${FORMATTED_PR_MESSAGES}"}}]}
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        

