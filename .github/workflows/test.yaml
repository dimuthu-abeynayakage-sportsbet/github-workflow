name: Test Actions
on: push

env:
  STACK_PREFIX: 'dka'
  STACK: 'ecs'
  ECS_DEPLOYMENT: 'blue'
  ECS_LIVE_STACK: 'blue'
  STACK_PROFILE: 'default'
  ACCOUNT: 'sp-dev'
  DOCKER_TAG: '123456789-docker'
  DEPLOY_EXCLUSIVE: true
  SKIP_CDK_DIFF: true
  
jobs:
  pre-deploy:
    runs-on: ubuntu-latest
    outputs:
      STACK_PREFIX_LC: ${{ steps.stack-prefix.outputs.STACK_PREFIX_LC }}
    steps:
      - id: stack-prefix
        run: |
         sp=${{ env.STACK_PREFIX }}
         echo "STACK_PREFIX_LC=${sp,,}" >> $GITHUB_OUTPUT
         echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
         echo "REpo: ${{ github.repository }}"
    
  test-workflows:
    runs-on: ubuntu-latest
    needs: pre-deploy
    steps:
      - run: |
            stackPrefixValue="${{ needs.pre-deploy.output.STACK_PREFIX_LC }}"
            stackPrefix=$([ stackPrefixValue != "" ] && echo "${stackPrefixValue}-" || echo "")
            echo "stackPrefix: ${stackPrefix}"
            #stackName=$([ env.STACK == "ecs" || env.STACK == "dashboard" ] && echo "${{ env.STACK }}-${{ env.ECS_DEPLOYMENT }}" || echo "${{ env.STACK }}")
            #echo "stackName=${stackPrefix}${stackName}"  >> $GITHUB_ENV
            #stackPrefixCdk=$([ stackPrefixLowerCase != "" ] && echo "-c stackPrefix=${stackPrefixLowerCase} " || echo "")
            #stackPrefixCdkContext="-c stackProfile=${{ env.STACK_PROFILE }} -c dockerimagetag=${{ env.DOCKER_TAG }} -c ecscolour=${{ env.ECS_DEPLOYMENT }} -c ecslive=${{ env.ECS_LIVE_STACK }}"
            #echo "stackPrefixCdkContext=${stackPrefixCdk}${stackPrefixCdkContext}"  >> $GITHUB_ENV
            #echo "exclusive=${{ (env.DEPLOY_EXCLUSIVE) && '--exclusively' || '' }}" >> $GITHUB_ENV
            #echo "force=${{ (env.SKIP_CDK_DIFF) && '--force' || '' }}" >> $GITHUB_ENV
            #echo "stackPrefixLowerCase: ${stackPrefixLowerCase}"
            echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
      - run: |
          echo "yarn cdk diff --fail tokeniser-api-cdk-${{ env.ACCOUNT }}-${{ env.stackName }} ${{ env.stackPrefixCdkContext }} ${{ env.scalingProfile }} -c dockerTag=${{ env.DOCKER_TAG }} ${{ env.exclusive }}"
        
